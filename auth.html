<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conectar con Google | MiTempo</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #f6f7f9;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --brand: #16a34a;
      --brand-600: #059669;
      --warn: #b91c1c;
      --ring: rgba(22, 163, 74, 0.25);
      --shadow: 0 10px 25px rgba(2, 6, 23, 0.08);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1220;
      --card: #0f172a;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --shadow: 0 10px 25px rgba(0,0,0,0.5);
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background: radial-gradient(1200px 1200px at 50% -10%, #e8fff1 0%, var(--bg) 45%);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 28px;
    }
    .logo {
      display: grid;
      place-items: center;
      margin-bottom: 8px;
    }
    .logo-circle {
      width: 56px; height: 56px; border-radius: 50%;
      background: linear-gradient(135deg, var(--brand), var(--brand-600));
      display: grid; place-items: center;
      color: #fff; font-weight: 800; letter-spacing: .5px;
    }
    h1 {
      font-size: clamp(20px, 2.2vw, 26px);
      margin: 8px 0 6px;
      text-align: center;
    }
    p.sub {
      margin: 0 0 16px;
      color: var(--muted);
      text-align: center;
      font-size: 14px;
    }
    .notice {
      background: #ecfdf5;
      border: 1px solid #d1fae5;
      color: #064e3b;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 14px;
      margin: 14px 0 18px;
    }
    .steps { margin: 16px 0 18px; padding-left: 2px;}
    .step { display: grid; grid-template-columns: 28px 1fr; gap: 10px; margin: 10px 0; }
    .bullet {
      width: 28px; height: 28px; border-radius: 50%;
      display: grid; place-items: center;
      background: #e7f6ee; color: #065f46; font-weight: 700; font-size: 13px;
      border: 1px solid #c7f0db;
    }
    .step p { margin: 4px 0 0; color: var(--muted); font-size: 14px; }
    .btn {
      width: 100%;
      border: 0;
      background: var(--brand);
      color: white;
      padding: 14px 18px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 6px 16px var(--ring);
      transition: transform .06s ease, filter .2s ease;
    }
    .btn:hover { filter: brightness(1.03); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .hint {
      margin-top: 10px; color: var(--muted); font-size: 12px; text-align: center;
    }
    .error {
      background: #fef2f2; border: 1px solid #fecaca; color: var(--warn);
      padding: 10px 12px; border-radius: 10px; font-size: 14px; margin: 8px 0 14px;
    }
    .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0 0 0 0); white-space: nowrap; }
    .fade-in { animation: fade .35s ease; }
    @keyframes fade { from {opacity:.6; transform: translateY(2px);} to {opacity:1; transform:none;} }
  </style>
</head>
<body>
  <main class="card fade-in" id="card">
    <div class="logo">
      <div class="logo-circle">MT</div>
    </div>
    <h1>Conectar con Google</h1>
    <p class="sub">Conectemos tu cuenta para que MiTempo funcione.</p>

    <div class="notice" id="notice">
      <strong>Permisos necesarios:</strong>
      <div style="height:6px"></div>
      • Crear y actualizar tus <strong>Google Sheets</strong>.<br/>
      • Leer y gestionar eventos en tu <strong>Google Calendar</strong>.
    </div>

    <div class="steps">
      <div class="step">
        <div class="bullet">1</div>
        <div>
          <strong>Tocá “Conectar con Google”.</strong>
          <p>Se abrirá la pantalla segura de Google para autorizar.</p>
        </div>
      </div>
      <div class="step">
        <div class="bullet">2</div>
        <div>
          <strong>Aceptá los permisos.</strong>
          <p>Solo para que el asistente pueda escribir en tu hoja y agendar.</p>
        </div>
      </div>
      <div class="step">
        <div class="bullet">3</div>
        <div>
          <strong>Vas a volver acá automáticamente.</strong>
          <p>Te confirmamos si quedó conectado.</p>
        </div>
      </div>
    </div>

    <div id="errorBox" class="error" style="display:none"></div>

    <button id="connectBtn" class="btn">
      Conectar con Google
    </button>
    <div class="hint" id="hint">Si tenés varias cuentas, elegí la que vas a usar con MiTempo.</div>
  </main>

  <script>
    // ≡≡≡ CONFIG ≡≡≡
    const GOOGLE_CLIENT_ID = "TU_CLIENT_ID_DE_GOOGLE.apps.googleusercontent.com"; // ← REEMPLAZAR
    const REDIRECT_URI     = "https://sebabiole.app.n8n.cloud/webhook/google-callback"; // webhook n8n
    // Scopes mínimos para tu caso (podés ajustar/expandir)
    const SCOPES = [
      "https://www.googleapis.com/auth/spreadsheets",
      "https://www.googleapis.com/auth/calendar"
    ];

    // ≡≡≡ HELPERS ≡≡≡
    const $  = sel => document.querySelector(sel);
    const qs = new URLSearchParams(location.search);

    function b64url(str) {
      return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/,"");
    }

    function showError(msg) {
      const box = $("#errorBox");
      box.textContent = msg;
      box.style.display = "block";
    }

    function normalizePhone(val) {
      // trae últimos 10 dígitos (formato local argentino, ej: 3382416087)
      const d = String(val || "").replace(/\D/g, "");
      return d.slice(-10);
    }

    function buildAuthUrl(u, p) {
      const stateObj = { u, p, ts: Date.now() };
      const stateB64 = b64url(JSON.stringify(stateObj));
      const params = new URLSearchParams({
        client_id: GOOGLE_CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        response_type: "code",
        scope: SCOPES.join(" "),
        access_type: "offline",
        include_granted_scopes: "true",
        prompt: "consent",
        state: stateB64
      });
      return `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
    }

    // ≡≡≡ MAIN ≡≡≡
    (function init(){
      const uRaw = qs.get("u") || "";
      const pRaw = (qs.get("p") || "prueba").toLowerCase();
      const debug = qs.has("debug"); // ?debug para evitar el auto-redirect, útil en testing

      const u = normalizePhone(uRaw);
      const p = pRaw.trim();

      // Validaciones básicas
      if (!u || !/^\d{10}$/.test(u)) {
        showError("Número de WhatsApp inválido o faltante. Volvé atrás y registrate nuevamente.");
        $("#connectBtn").disabled = true;
        return;
      }
      if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.startsWith("TU_CLIENT_ID")) {
        showError("Falta configurar el Client ID de Google. Avisá a soporte.");
        $("#connectBtn").disabled = true;
        return;
      }

      const authUrl = buildAuthUrl(u, p);

      // Click manual (fallback si el navegador bloquea la redirección)
      $("#connectBtn").addEventListener("click", () => {
        location.href = authUrl;
      });

      // Auto-redirect suave (salvo que esté en modo debug)
      if (!debug) {
        setTimeout(() => {
          // Usamos replace para que el back no regrese a esta pantalla
          location.replace(authUrl);
        }, 600); // pequeño delay para que el usuario lea el paso 1
      } else {
        // Modo debug visible
        $("#hint").textContent = "DEBUG activo: no se redirige automáticamente.";
        $("#notice").insertAdjacentHTML("beforeend",
          `<div style="margin-top:10px;font-size:12px">
             <strong>Auth URL:</strong><br>
             <code style="word-break:break-all">${authUrl}</code>
           </div>`);
      }
    })();
  </script>
</body>
</html>
