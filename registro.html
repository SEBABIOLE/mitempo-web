<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro | MiTempo.app</title>
  <meta name="robots" content="noindex, nofollow">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; base-uri 'self';
                 script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src https://fonts.gstatic.com;
                 img-src 'self' data:;
                 connect-src 'self' https://sebabiole.app.n8n.cloud;
                 frame-ancestors 'none';">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; }
    .error { color: #dc2626; font-size: .875rem; margin-top: 0.25rem; }
    #msg { text-align: center; margin-bottom: 1rem; font-size: 1rem; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .hidden { display: none; }
    #debug { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
             white-space: pre-wrap; font-size: 12px; background:#0b1020; color:#e4e7ef; padding:10px; border-radius:8px; margin-top:14px; display:none;}
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-md rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-semibold mb-4 text-center">Regístrate y activa tu prueba</h1>

    <div id="msg" role="status" aria-live="polite"></div>

    <form id="form" class="space-y-4" novalidate>
      <div>
        <label class="block text-sm font-medium mb-1" for="fullName">Nombre y Apellido <span class="text-red-500">*</span></label>
        <input type="text" id="fullName" required autocomplete="name"
               class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-400" />
        <p id="errFullName" class="error hidden">Ingresa un nombre válido (mínimo 2 caracteres).</p>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="phone">WhatsApp (10 dígitos locales, sin 0 ni prefijo) <span class="text-red-500">*</span></label>
        <input type="text" id="phone" inputmode="numeric" autocomplete="tel" required
               class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-400" />
        <p id="errPhone" class="error hidden">Ingresa 10 dígitos locales válidos.</p>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="email">Email <span class="text-red-500">*</span></label>
        <input type="email" id="email" autocomplete="email" required
               class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-400" />
        <p id="errEmail" class="error hidden">Ingresa un email válido.</p>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="plan">Plan <span class="text-red-500">*</span></label>
        <select id="plan" required
                class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-400">
          <option value="prueba">Prueba</option>
          <option value="bronce">Bronce</option>
          <option value="plata">Plata</option>
          <option value="oro">Oro</option>
          <option value="duo">Duo</option>
        </select>
      </div>

      <div id="invitedByContainer" class="hidden">
        <label class="block text-sm font-medium mb-1" for="invitedBy">¿Invitado por alguien? (celular de la persona) <span class="text-red-500">*</span></label>
        <input type="text" id="invitedBy" placeholder="1234567890" inputmode="numeric" autocomplete="tel-national"
               class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-400" />
        <p id="errInvitedBy" class="error hidden">Ingresa 10 dígitos locales válidos.</p>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="howHeard">¿Cómo te enteraste de MiTempo? (opcional)</label>
        <input type="text" id="howHeard" autocomplete="off"
               class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-400" />
      </div>

      <button type="submit" id="submitBtn"
              class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition">
        Enviar Registro
      </button>

      <div id="debug"></div>
    </form>
  </div>

  <script>
    const ENDPOINT = 'https://sebabiole.app.n8n.cloud/webhook/registro-formulario';
    const $ = id => document.getElementById(id);
    const qp = new URLSearchParams(location.search);
    const debug = qp.get('debug') === '1';
    const log = (...a) => { if (debug) { console.log(...a); const d=$('debug'); d.style.display='block'; d.textContent += a.map(x => typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ') + '\\n'; } };

    const safe = s => (s || '').toString().replace(/[<>"'`]/g, '');

    function resetUI() {
      ['errFullName','errPhone','errEmail','errInvitedBy'].forEach(id => $(id).classList.add('hidden'));
      $('msg').textContent = ''; $('msg').style.color = ''; $('submitBtn').disabled = false;
    }
    function toggleDuo() {
      const isDuo = $('plan').value === 'duo';
      $('invitedByContainer').classList.toggle('hidden', !isDuo);
      const i = $('invitedBy');
      if (isDuo) i.setAttribute('required','true'); else { i.removeAttribute('required'); i.value=''; $('errInvitedBy').classList.add('hidden'); }
    }
    $('plan').addEventListener('change', toggleDuo);

    // Prefill opcional
    const p0 = (qp.get('p') || '').toLowerCase();
    if (p0 && ['prueba','bronce','plata','oro','duo'].includes(p0)) { $('plan').value = p0; }
    const n0 = safe(qp.get('n') || '');
    if (n0) $('fullName').value = n0;
    toggleDuo();

    // Helper timeout para fetch
    const fetchWithTimeout = (url, opts={}, ms=20000) => {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), ms);
      const merged = { ...opts, signal: controller.signal };
      return fetch(url, merged).finally(() => clearTimeout(t));
    };

    $('form').addEventListener('submit', async (e) => {
      e.preventDefault();
      resetUI();

      // Validaciones
      const fullName = $('fullName').value.trim();
      const phoneRaw = $('phone').value.trim().replace(/\D/g,'').replace(/^0+/, '');
      const email = $('email').value.trim();
      const plan = $('plan').value;
      const invitedRaw = ($('invitedBy').value || '').trim().replace(/\D/g,'').replace(/^0+/, '');
      const howHeard = $('howHeard').value.trim();

      let ok = true;
      if (!/^[a-zA-ZÁÉÍÓÚáéíóúñÑ\s]{2,}$/.test(fullName)) { $('errFullName').classList.remove('hidden'); ok=false; }
      if (!/^\d{10}$/.test(phoneRaw)) { $('errPhone').classList.remove('hidden'); ok=false; }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { $('errEmail').classList.remove('hidden'); ok=false; }
      if (plan==='duo' && !/^\d{10}$/.test(invitedRaw)) { $('errInvitedBy').classList.remove('hidden'); ok=false; }
      if (!ok) return;

      const celular10 = phoneRaw;
      const celular_e164 = `+549${celular10}`;
      const celular_whatsapp = `whatsapp:${celular_e164}`;
      const invited_e164 = plan==='duo' ? `+549${invitedRaw}` : '';
      const invited_wa   = invited_e164 ? `whatsapp:${invited_e164}` : '';

      // Payload EXACTO que espera tu webhook (queda dentro de body en n8n)
      const data = {
        Nombre: fullName,
        Email: email,
        Celular: celular10,                 // 10 dígitos
        celular_e164,                       // +549XXXXXXXXXX
        celular_whatsapp,                   // whatsapp:+549XXXXXXXXXX
        user_id: celular_whatsapp,          // usamos ESTE para lookups
        plan,
        origen: howHeard,
        howHeard,

        // duplicados para TEXT en Sheets
        Celular_txt: `'${celular10}`,
        celular_e164_txt: `'+549${celular10}`,
        celular_whatsapp_txt: `'whatsapp:+549${celular10}`,

        invitedBy_celular: invitedRaw || '',
        invitedBy_e164: invited_e164,
        invitedBy_whatsapp: invited_wa,

        invitedBy_celular_txt: invitedRaw ? `'${invitedRaw}` : '',
        invitedBy_e164_txt: invited_e164 ? `'${invited_e164}` : '',
        invitedBy_whatsapp_txt: invited_wa ? `'${invited_wa}` : '',

        state: qp.get('state') || '',
        id_token: qp.get('id_token') || '',
        expired: qp.get('expired') || ''
      };

      $('msg').textContent = 'Enviando registro…';
      $('msg').style.color = '#10b981';
      $('submitBtn').disabled = true;

      log('Origin:', location.origin);
      if (debug && location.origin !== 'https://mitempo.app') {
        log('⚠️ OJO: el Webhook tiene CORS restringido a https://mitempo.app. Si probás desde otro origen, fetch va a fallar.');
      }

      const payload = JSON.stringify(data);
      let enviado = false;
      let lastError = null;

      // 1) fetch JSON (con timeout, CORS)
      try {
        const res = await fetchWithTimeout(ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: payload,
          mode: 'cors',
          keepalive: true,
        }, 20000);
        log('fetch status:', res.status);
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        enviado = true;
      } catch (err) {
        lastError = err;
        log('fetch error:', err && (err.message || err));
      }

      // 2) fallback sendBeacon (text/plain)
      if (!enviado) {
        try {
          const ok2 = navigator.sendBeacon(
            ENDPOINT,
            new Blob([payload], { type: 'text/plain;charset=UTF-8' })
          );
          log('sendBeacon result:', ok2);
          if (!ok2) throw new Error('sendBeacon devolvió false');
          enviado = true;
        } catch (err2) {
          lastError = err2;
          log('sendBeacon error:', err2 && (err2.message || err2));
        }
      }

      if (enviado) {
        $('msg').textContent = '¡Listo! Te acabamos de escribir por WhatsApp. Abrí el chat y respondé “Hola”.';
        $('msg').style.color = '#10b981';
        // Paso 2: pantalla de gracias (simple)
        setTimeout(() => { window.location.href = '/gracias.html'; }, debug ? 2000 : 600);
      } else {
        $('msg').textContent = `No pudimos enviar el registro. ${lastError ? (lastError.message || lastError) : ''}`;
        $('msg').style.color = '#dc2626';
        $('submitBtn').disabled = false;
      }
    });
  </script>
</body>
</html>
